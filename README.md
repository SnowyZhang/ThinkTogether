# ThinkTogether
ThinkTogether致力于打造一款多人协作的在线文档系统，核心功能包括：实时协作编辑、灵活的文档权限管理、实时内容同步以及高效的文档创建与管理。通过这些功能，用户能够实现无缝的团队合作，提升工作效率和文档管理的便捷性。

## 1. 需求分析

### 1.1 系统实体
系统中主要包含以下两大实体：用户（Person）和文档（Document）。

- **用户（User）**
    - **属性**：用户ID、用户名、密码、手机号、邮箱、性别、注册时间、上次登录时间。

- **文档（Document）**
    - **属性**：文档ID、文档名称、文档内容、创建者ID、创建时间。

### 1.2 用户与文档关系
- 一个用户可以创建多个文档。
- 每个文档归属于唯一的创建者（文档和用户是一对多关系）。

### 1.3 权限管理
- 权限类型：**阅读**、**编辑**。
- 权限管理采用基于用户的权限控制（ABAC），即每个用户根据其角色对特定文档拥有特定的操作权限。

### 1.4 协作需求
- 多人可以同时编辑同一个文档。
- 用户的编辑内容实时同步到其他协作用户。
- 编辑内容冲突需要合并解决（如使用OT算法、diff+patch等合并技术）。
- 用户需实时看到其他人的编辑内容和修改区域。

### 1.5 主要功能模块
- **人员管理**：用户注册、登录、身份验证。
- **文档管理**：创建、查看、修改、删除文档。
- **权限管理**：设置文档的读/写权限，校验用户权限。
- **协作功能**：多人实时协作，合并冲突，消息推送。
- **前端文档编辑器**：实现文档内容的可编辑、文本样式调整、插入图片、插入链接等。

---

## 2. 功能模块设计

### 2.1 人员管理
人员管理模块主要负责用户的注册、登录和身份验证。其表结构如下：

| 字段        | 描述                   |
| ----------- | ---------------------- |
| 用户ID      | 唯一标识一个用户       |
| 用户名      | 用户名                 |
| 密码        | 加密存储的密码         |
| 手机号      | 用户的手机号           |
| 邮箱        | 用户的邮箱地址         |
| 性别        | 用户的性别             |
| 注册时间    | 用户注册的时间         |
| 上次登录时间| 用户上次登录的时间     |

主要功能：
- **用户注册**：前端发送用户名、密码等信息，后端生成用户ID并存入数据库。
- **用户登录**：前端通过用户名和密码进行登录，后台验证正确性后，生成一个Token返回客户端用于后续请求。

### 2.2 文档管理
文档管理模块负责文档的创建、修改、查看、删除等操作。其表结构如下：

| 字段        | 描述                   |
| ----------- | ---------------------- |
| 文档ID      | 唯一标识一个文档       |
| 文档名称    | 文档的标题             |
| 文档内容    | 文档的具体内容         |
| 创建者ID    | 文档创建者的用户ID     |
| 创建时间    | 文档创建的时间         |

主要功能：
- **创建文档**：前端发送文档名称和初始内容，后端生成文档ID并保存到数据库。
- **修改文档**：前端发送编辑后的内容，服务端实时合并并保存修改。
- **查看文档**：前端请求文档ID，后端返回文档内容。
- **删除文档**：前端请求删除文档，服务端删除对应文档。

### 2.3 权限管理
权限管理模块根据用户与文档的关联关系，为用户设置特定的权限。表结构如下：

| 字段        | 描述                   |
| ----------- | ---------------------- |
| 用户ID      | 用户的唯一标识         |
| 文档ID      | 文档的唯一标识         |
| 权限类型    | 阅读/编辑权限           |

主要功能：
- **开通权限**：前端通过文档ID和权限类型请求，服务端在权限表中添加记录。
- **删除权限**：前端通过文档ID和权限类型请求，服务端在权限表中删除记录。
- **权限校验**：每次访问文档前，服务端检查用户是否具备相应的权限。

### 2.4 协作功能（重点）
协作功能模块解决多人同时编辑同一文档时的数据同步和冲突合并问题。关键技术点包括：
- **实时编辑**：采用WebSocket或长连接（SSE）进行实时数据推送。
- **冲突解决**：采用OT算法或diff+patch算法解决并发修改时的冲突。
- **消息推送**：当有用户加入或退出文档时，服务端通过推送通知其他用户。
- **操作合并**：每个用户的操作需通过协议（如Protobuf）发送给服务端，服务端进行合并并存储。

**此部分详细设计见协作设计.md，待进一步完善。**

### 2.5 前端文档编辑器
编辑器功能包括：
- **编辑功能**：支持文本内容的输入、样式修改（如字体、颜色）、插入图片、插入链接等。
- **上报功能**：修改内容需经过防抖处理批量上报，避免频繁请求。
- **本地存储**：为避免网络中断导致的丢失，支持将用户未保存的内容临时存储到浏览器的LocalStorage中。

---

## 3. 技术栈选择

- **后端框架**：Spring Boot（简化开发流程，提高生产力）。
- **数据库**：MySQL（关系型数据库，适合存储用户和文档数据）。
- **消息队列**：RocketMQ（确保消息的顺序性和可靠性，适用于高并发场景）或Kafka。
- **WebSocket**：实现实时协作和数据推送。
- **Protobuf**：高效的二进制协议，用于客户端与服务端之间的文档修改内容传输。
- **前端框架**：React（适合构建响应式和交互性强的文档编辑器）待定。

---

## 4. 系统架构设计

### 4.1 系统架构图
[系统架构图]待插入

架构包括以下几个关键模块：
1. **接入层**：负责用户身份验证，接收前端请求并将请求路由到相应的服务模块。
2. **用户服务**：负责用户管理、权限校验等。
3. **文档服务**：处理文档的增删改查操作。
4. **协作服务**：处理文档实时编辑、冲突合并、消息推送等。
5. **消息队列**：RocketMQ用于确保多个用户的操作顺序一致性。
6. **数据库**：存储用户和文档信息。
7. **前端应用**：React应用提供用户界面，支持实时协作和文档编辑。

### 4.2 数据库设计
- 用户信息表、文档信息表和权限表已在前文提及，数据库采用MySQL存储。
- 为支持全文搜索，建议使用Elasticsearch进行文档内容索引。

### 4.3 消息推送与长连接
- 使用WebSocket建立长连接，实现客户端和服务端之间的实时通信，确保编辑内容的实时同步。

